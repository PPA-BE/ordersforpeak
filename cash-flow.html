<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cash Flow Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script defer src="./src/msal.js" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    body { background:#f1f5f9; }
    .kpi { background:#ffffff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; }
    .card { background:#ffffff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; }
  
    .chart-wrap { height: 320px; }
    .chart-wrap.tall { height: 380px; }
    .card canvas { width: 100% !important; height: 100% !important; display:block; }
    .btn-ghost{
      display:inline-flex;align-items:center;justify-content:center;
      padding:0.25rem 0.5rem;
      border-radius:0.375rem;
      background:#334155;
      color:#fff;
      font-weight:500;
      transition:background .15s ease;
    }
    .btn-ghost:hover{ background:#0f172a; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div id="authGate" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="animate-pulse text-slate-600 mb-2">Connecting to Microsoft…</div>
      <div class="text-xs text-slate-500">Nearly there... do not refresh the page.</div>
    </div>
  </div>

  <div id="app" class="hidden p-6">
    <div class="max-w-7xl mx-auto space-y-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-semibold">Cash Flow Dashboard</h1>
          <div class="text-xs text-slate-500">Signed in as: <span id="whoami" class="font-medium"></span></div>
        </div>
        <div class="flex gap-2">
          <a href="./index.html" class="px-3 py-2 rounded bg-slate-600 text-white hover:bg-slate-800">← Back to Requisitions</a>
          <button id="logout" class="px-3 py-2 rounded bg-slate-700 text-white hover:bg-black">Logout</button>
        </div>
      </div>

      <div class="card">
        <div class="flex flex-wrap gap-3 items-end">
          <div>
            <label class="block text-xs text-slate-500 mb-1">Year</label>
            <select id="yearSel" class="px-3 py-2 rounded border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">Meeting Month</label>
            <select id="monthSel" class="px-3 py-2 rounded border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">View</label>
            <select id="viewSel" class="px-3 py-2 rounded border border-slate-300 bg-white">
              <option value="month">Meeting Month Only</option>
              <option value="ytd">YTD to Meeting Month</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">Department</label>
            <select id="deptSel" class="px-3 py-2 rounded border border-slate-300 bg-white"><option value="">All</option></select>
          </div>
          <button id="refresh" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Refresh</button>
          <div id="lastRefreshed" class="text-xs text-slate-500 ml-auto"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="kpi">
          <div class="text-xs text-slate-500">Paid This Month</div>
          <div id="kpiPaidMonth" class="text-2xl font-semibold">—</div>
        </div>
        <div class="kpi">
          <div class="text-xs text-slate-500">Committed (Approved, Unpaid)</div>
          <div id="kpiCommitted" class="text-2xl font-semibold">—</div>
        </div>
        <div class="kpi">
          <div class="text-xs text-slate-500">Pipeline (Submitted / Pending)</div>
          <div id="kpiPipeline" class="text-2xl font-semibold">—</div>
        </div>
        <div class="kpi">
          <div class="text-xs text-slate-500">Outstanding Over 30d</div>
          <div id="kpiAging" class="text-2xl font-semibold">—</div>
        </div>
        <div class="kpi">
          <div class="text-xs text-slate-500">Received, Not Invoiced (RNI)</div>
          <div id="kpiRNI" class="text-2xl font-semibold">—</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="card">
          <div class="text-sm font-semibold mb-2">Monthly Outflows (Paid)</div>
          <div class="chart-wrap"><canvas id="paidByMonth"></canvas></div>
        </div>
        <div class="card">
          <div class="text-sm font-semibold mb-2">Commitments by Status</div>
          <div class="chart-wrap"><canvas id="byStatus"></canvas></div>
        </div>
        <div class="card">
          <div class="text-sm font-semibold mb-2">Spend by Department</div>
          <div class="chart-wrap"><canvas id="byDepartment"></canvas></div>
        </div>
        <div class="card">
          <div class="text-sm font-semibold mb-2">Top Vendors (YTD)</div>
          <div class="chart-wrap"><canvas id="topVendors"></canvas></div>
        </div>
        <div class="card">
          <div class="text-sm font-semibold mb-2">Aging (Unpaid)</div>
          <div class="chart-wrap"><canvas id="aging"></canvas></div>
        </div>
        <div class="card">
          <div class="text-sm font-semibold mb-2">Simple Cash Projection</div>
          <div class="chart-wrap"><canvas id="projection"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">Rows</div>
          <div class="text-xs text-slate-500">Showing filtered results</div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full border-separate border-spacing-0 text-sm">
            <thead>
              <tr class="bg-slate-50 text-xs text-slate-600 uppercase">
                <th class="text-left py-2 px-2 border border-slate-200">RO ID</th>
                <th class="text-left py-2 px-2 border border-slate-200">Submitted</th>
                <th class="text-left py-2 px-2 border border-slate-200">Vendor</th>
                <th class="text-left py-2 px-2 border border-slate-200">Department</th>
                <th class="text-right py-2 px-2 border border-slate-200">Total</th>
                <th class="text-left py-2 px-2 border border-slate-200">Status</th>
                <th class="text-left py-2 px-2 border border-slate-200">Paid At</th>
                <th class="text-center py-2 px-2 border border-slate-200 w-24">Action</th>
              </tr>
            </thead>
            <tbody id="rowsTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="toast" class="toast hidden">Saved!</div>
    </div>
  </div>

  <div id="app-modal" class="fixed inset-0 z-[2147483646] hidden">
    <div class="absolute inset-0 bg-black/50" data-modal-close></div>
    <div class="relative mx-auto my-10 w-[92%] max-w-4xl">
      <div class="relative bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200 p-4">
        <button id="app-modal-close" type="button"
          class="absolute top-2 right-2 rounded-full w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 hover:bg-slate-100"
          aria-label="Close">✕</button>
        <div id="app-modal-content"></div>
      </div>
    </div>
  </div>


  <script type="module">
    import { initAuth, revealAppUI, logout } from "./src/msal.js";
    import { renderCashFlow } from "./src/ui/cashflow.js";

    document.getElementById("logout").addEventListener("click", logout);

    initAuth({
      onReady: async () => {
        await revealAppUI();
        await renderCashFlow();
      }
    });
  </script>
</body>
</html>