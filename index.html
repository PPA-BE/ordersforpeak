<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Requisition Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <style>
    body { background:#f1f5f9; }
    input:focus { outline:2px solid #2563eb; outline-offset:-1px; }
    .toast { position:fixed; right:16px; bottom:16px; padding:10px 14px; background:#16a34a; color:#fff; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.2);}
    .label { font-size:12px; font-weight:600; color:#475569; }
    .muted { color:#64748b; font-size:12px; }
    .vendor-list { max-height: 220px; overflow:auto; border:1px solid #e2e8f0; border-radius: 8px; }
    .vendor-row { padding:8px 10px; border-bottom:1px solid #f1f5f9; cursor:pointer; }
    .vendor-row:hover { background:#f8fafc; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tfoot-label { background:#f8fafc }
    .break-anywhere { overflow-wrap: anywhere; word-break: break-word; }
    #cmt-content { max-height: 70vh; overflow: auto; }
    .btn-ghost{
      display:inline-flex;align-items:center;justify-content:center;
      padding:0.25rem 0.5rem;
      border-radius:0.375rem;
      background:#334155;
      color:#fff;
      font-weight:500;
      transition:background .15s ease;
    }
    .btn-ghost:hover{ background:#0f172a; }
  </style>
</head>
<body>

<div id="authGate" class="min-h-screen flex items-center justify-center">
  <div class="text-center">
    <div class="animate-pulse text-slate-600 mb-2">Connecting to Microsoft…</div>
    <div class="text-xs text-slate-500">Nearly there... do not refresh the page.</div>
  </div>
</div>

<div id="app" class="hidden p-6">
  <div class="max-w-7xl mx-auto space-y-6">

    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Requisition Portal</h1>
        <div class="text-xs text-slate-500">Signed in as: <span id="whoami" class="font-medium"></span></div>
      </div>
      <div class="flex gap-2">
        
        <a href="./cash-flow.html" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Cash Flow Dashboard</a>
<button id="clearAll" class="px-3 py-2 rounded bg-slate-600 text-white hover:bg-slate-700">Clear</button>
        <button id="exportExcel" class="px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Export Excel</button>
        <button id="logout" class="px-3 py-2 rounded bg-slate-700 text-white hover:bg-black">Logout</button>
      </div>
    </div>

    <div id="managerCard" class="rounded-lg shadow bg-white p-4 hidden">
      <div class="text-sm font-semibold mb-2">Your Manager</div>
      <div id="managerBody" class="text-sm text-slate-700"><span class="opacity-70">Loading your manager…</span></div>
    </div>

    <div class="rounded-lg shadow bg-white p-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="border rounded-lg p-3">
          <div class="text-sm font-semibold mb-2">Vendor</div>

          <label class="label">Search Vendors (ID or Name)</label>
          <div class="flex gap-2 mb-2">
            <input id="vendorSearch" class="w-full px-2 py-1 border border-slate-300 rounded" placeholder="Start typing…" />
            <button id="vendorLoad" class="px-3 py-1 rounded bg-slate-700 text-white hover:bg-black whitespace-nowrap">Load</button>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <span class="muted">Contact Mollie if you cannot find your supplier here.</span>
            <span class="text-xs px-2 py-0.5 rounded bg-slate-100 text-slate-700"><span id="vendorCount">0</span> vendors</span>
            <span id="vendorFilterCount" class="muted"></span>
          </div>
          <div id="vendorResults" class="vendor-list hidden" role="listbox" aria-label="Vendor results"></div>

          <label class="label mt-3">Vendor Name (selected)</label>
          <input id="vendorName" class="w-full px-2 py-1 border border-slate-300 rounded mb-2" placeholder="e.g., SecurityOne" />

          <input id="vendorId" type="hidden" />

          <label class="label">Address</label>
          <input id="vendorAddr1" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100 mb-2" placeholder="Address" readonly />

          <div class="grid grid-cols-3 gap-2 mb-2">
            <div>
              <label class="label">City</label>
              <input id="vendorCity" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100" placeholder="City" readonly />
            </div>
            <div>
              <label class="label">State/Prov</label>
              <input id="vendorState" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100" placeholder="State/Prov" readonly />
            </div>
            <div>
              <label class="label">Postal Code</label>
              <input id="vendorZip" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100" placeholder="Postal Code" readonly />
            </div>
          </div>

          <label class="label">Vendor Reference No</label>
          <input id="vendorRefNo" class="w-full px-2 py-1 border border-slate-300 rounded" placeholder="Optional reference" />
        </div>

        <div class="border rounded-lg p-3">
          <div class="text-sm font-semibold mb-2">Ship To</div>
          <div class="text-sm text-slate-800 whitespace-pre-line select-none">
Peak Processing Solutions
2065 Solar Crescent
Oldcastle, ON, Canada
N0R1L0
          </div>
        </div>

        <div class="border rounded-lg p-3">
          <div class="text-sm font-semibold mb-2">PO Details</div>
          <div class="grid grid-cols-1 gap-2">
            <div>
              <label class="label">Date</label>
              <input id="poDate" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100" readonly />
            </div>
            <div>
              <label class="label">Peak HST No</label>
              <input id="peakHst" class="w-full px-2 py-1 border border-slate-300 rounded bg-slate-100" value="HST 709184311 RT0001" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="poTableShell" class="relative">
      <button
        id="addRowSide"
        class="absolute -left-5 top-1/2 -translate-y-1/2 z-10 flex items-center justify-center
               w-9 h-9 rounded-full bg-emerald-600 text-white shadow-lg
               hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
        title="Add row"
        aria-label="Add row">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6z"/>
        </svg>
      </button>

      <div class="overflow-x-auto rounded-lg shadow bg-white">
        <table id="poTable" class="min-w-full border-separate border-spacing-0">
          <thead>
            <tr class="bg-slate-800 text-white text-xs uppercase">
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-20">Line #</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-44">Supplier Item #</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-40">Peak Part #</th>
              <th class="text-left font-semibold py-3 px-2 border border-slate-300">
                Description
                <div class="text-[11px] font-normal opacity-80">Brand Name, Potency/Strength (if applicable)</div>
              </th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-24">Quantity</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-28">UOM</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-28">Unit Price</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-28">Line Total</th>
              <th class="text-center font-semibold py-3 px-2 border border-slate-300 w-12">✖</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="text-right pr-3 py-2 border border-slate-300 tfoot-label">Subtotal</td>
              <td class="text-right pr-2 py-2 border border-slate-300" id="subTotal">$0.00</td>
              <td class="border border-slate-300 tfoot-label"></td>
            </tr>
            <tr>
              <td colspan="7" class="text-right pr-3 py-2 border border-slate-300 tfoot-label">HST (13%)</td>
              <td class="text-right pr-2 py-2 border border-slate-300" id="hstAmount">$0.00</td>
              <td class="border border-slate-300 tfoot-label"></td>
            </tr>
            <tr>
              <td colspan="7" class="text-right pr-3 py-3 border border-slate-300 bg-slate-50 font-medium">Grand Total</td>
              <td class="text-right pr-2 py-3 border border-slate-300 font-semibold" id="grandTotal">$0.00</td>
              <td class="border border-slate-300 bg-slate-50"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="flex justify-end mt-3">
        <button id="sendForApproval" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 shadow">
          Send for Approval
        </button>
      </div>

    </div>

    <div id="dashboard" class="rounded-lg shadow bg-white p-4 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Requisition Order Management Dashboard</h2>
        <div class="flex items-center gap-2"><span id="dashAccessTag" class="text-xs px-2 py-1 rounded bg-slate-200 text-slate-700">Hidden</span>
        </div>
      </div>
      <div id="dashboardFiltersContainer" class="flex flex-wrap items-center gap-4 mb-4 p-3 bg-slate-50 rounded-lg border"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="border rounded-lg p-4"><div class="text-sm text-slate-500">ROs Shown</div><div id="metricCount" class="text-2xl font-bold">0</div></div>
        <div class="border rounded-lg p-4"><div class="text-sm text-slate-500">Total Value</div><div id="metricTotal" class="text-2xl font-bold">$0.00</div></div>
        <div class="border rounded-lg p-4"><div class="text-sm text-slate-500">Avg per RO</div><div id="metricAvg" class="text-2xl font-bold">$0.00</div></div>
      </div>
      <div class="mt-4">
        <div class="text-sm font-medium mb-2">Recent Requisition Orders</div>
        <div class="overflow-x-auto">
          <table class="min-w-full border-separate border-spacing-0">
            <thead>
              <tr class="bg-slate-50 text-xs text-slate-600 uppercase">
                <th class="text-left  py-2 px-2 border border-slate-200">RO ID</th>
                <th class="text-left  py-2 px-2 border border-slate-200">Submitted</th>
                <th class="text-right py-2 px-2 border border-slate-200">Lines</th>
                <th class="text-right py-2 px-2 border border-slate-200">Total</th>
                <th class="text-left  py-2 px-2 border border-slate-200">Vendor</th>
                <th class="text-left  py-2 px-2 border border-slate-200">Submitted By</th>
                <th class="text-left  py-2 px-2 border border-slate-200">Status</th>
                <th class="text-center py-2 px-2 border border-slate-200 w-32">Action</th>
              </tr>
            </thead>
            <tbody id="recentTable"></tbody>
          </table>
        </div>
        <div id="dashboardPagination" class="flex items-center justify-end gap-4 mt-4 text-sm">
            <button id="dashBackBtn" class="px-3 py-1.5 rounded bg-slate-600 text-white hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed">Back</button>
            <span id="dashPageIndicator" class="font-medium text-slate-700">Page 1 of 1</span>
            <button id="dashForwardBtn" class="px-3 py-1.5 rounded bg-slate-600 text-white hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed">Forward</button>
        </div>
      </div>
    </div>

    <div id="myHistoryPanel" class="rounded-lg shadow bg-white p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">My Requisition Requests</h2>
        <span class="text-xs text-slate-500">Click <span class="font-medium">Open</span> to load a RO into the form</span>
      </div>
      <div id="historyFiltersContainer" class="flex flex-wrap items-center gap-4 mb-4 p-3 bg-slate-50 rounded-lg border"></div>
      <div class="overflow-x-auto">
        <table class="min-w-full border-separate border-spacing-0">
          <thead>
            <tr class="bg-slate-50 text-xs text-slate-600 uppercase">
              <th class="text-left  py-2 px-2 border border-slate-200">RO ID</th>
              <th class="text-left  py-2 px-2 border border-slate-200">Submitted</th>
              <th class="text-right py-2 px-2 border border-slate-200">Lines</th>
              <th class="text-right py-2 px-2 border border-slate-200">Total</th>
              <th class="text-left  py-2 px-2 border border-slate-200">Vendor</th>
              <th class="text-left  py-2 px-2 border border-slate-200">Status</th>
              <th class="text-center py-2 px-2 border border-slate-200 w-32">Action</th>
            </tr>
          </thead>
          <tbody id="myHistoryBody"></tbody>
        </table>
      </div>
      <div id="historyPagination" class="flex items-center justify-end gap-4 mt-4 text-sm">
        <button id="historyBackBtn" class="px-3 py-1.5 rounded bg-slate-600 text-white hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed">Back</button>
        <span id="historyPageIndicator" class="font-medium text-slate-700">Page 1 of 1</span>
        <button id="historyForwardBtn" class="px-3 py-1.5 rounded bg-slate-600 text-white hover:bg-slate-700 disabled:bg-slate-300 disabled:cursor-not-allowed">Forward</button>
      </div>
    </div>

    <p class="text-xs text-slate-500">Tips: Tab/Shift+Tab to move, Enter on Unit Price recalculates, Ctrl/Cmd+S saves, Ctrl/Cmd+N adds a row. Contact Basel for support.</p>
  </div>

  <div id="toast" class="toast hidden"></div>
</div>

<div id="cmt-modal" class="fixed inset-0 z-[2147483647] hidden">
  <div class="absolute inset-0 bg-black/50" data-cmt-close></div>
  <div class="relative mx-auto my-10 w-[92%] max-w-md">
    <div class="relative bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200 p-4">
      <button id="cmt-close" type="button"
        class="absolute top-2 right-2 rounded-full w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 hover:bg-slate-100"
        aria-label="Close">✕</button>
      <div id="cmt-content"></div>
    </div>
  </div>
</div>

<div id="app-modal" class="fixed inset-0 z-[2147483646] hidden">
  <div class="absolute inset-0 bg-black/50" data-modal-close></div>
  <div class="relative mx-auto my-10 w-[92%] max-w-4xl">
    <div class="relative bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200 p-4">
      <button id="app-modal-close" type="button"
        class="absolute top-2 right-2 rounded-full w-8 h-8 flex items-center justify-center text-slate-500 hover:text-slate-800 hover:bg-slate-100"
        aria-label="Close">✕</button>
      <div id="app-modal-content"></div>
    </div>
  </div>
</div>

<script type="module" src="../src/app.js"></script>
</body>
</html>